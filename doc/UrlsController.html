<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: UrlsController
  
    &mdash; Documentation by YARD 0.8.7.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (U)</a> &raquo;
    
    
    <span class="title">UrlsController</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: UrlsController
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActionController::Base</li>
          
            <li class="next"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></li>
          
            <li class="next">UrlsController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/controllers/urls_controller.rb</dd>
  
</dl>
<div class="clear"></div>








  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-instance_method" title="#create (instance method)">- (Object) <strong>create</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>POST /urls POST /urls.json.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#destroy-instance_method" title="#destroy (instance method)">- (Object) <strong>destroy</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>DELETE /urls/1 DELETE /urls/1.json.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#edit-instance_method" title="#edit (instance method)">- (Object) <strong>edit</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>GET /urls/1/edit.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#find_urls-instance_method" title="#find_urls (instance method)">- (Object) <strong>find_urls</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#index-instance_method" title="#index (instance method)">- (Object) <strong>index</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>GET /urls GET /urls.json.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#new-instance_method" title="#new (instance method)">- (Object) <strong>new</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>GET /urls/new.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#show-instance_method" title="#show (instance method)">- (Object) <strong>show</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>GET /urls/1 GET /urls/1.json.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update-instance_method" title="#update (instance method)">- (Object) <strong>update</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>PATCH/PUT /urls/1 PATCH/PUT /urls/1.json.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_prices-instance_method" title="#update_prices (instance method)">- (Object) <strong>update_prices</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_single_price-instance_method" title="#update_single_price (instance method)">- (Object) <strong>update_single_price</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_violators-instance_method" title="#update_violators (instance method)">- (Object) <strong>update_violators</strong>(redirect_to_root = true, site_id = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ApplicationController.html#get_price-instance_method" title="ApplicationController#get_price (method)">#get_price</a></span>, <span class='object_link'><a href="ApplicationController.html#get_url-instance_method" title="ApplicationController#get_url (method)">#get_url</a></span>, <span class='object_link'><a href="ApplicationController.html#set_price-instance_method" title="ApplicationController#set_price (method)">#set_price</a></span>, <span class='object_link'><a href="ApplicationController.html#spaces-instance_method" title="ApplicationController#spaces (method)">#spaces</a></span></p>

  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="create-instance_method">
  
    - (<tt>Object</tt>) <strong>create</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>POST /urls POST /urls.json</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


40
41
42
43
44
45
46
47
48
49
50
51
52</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 40</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
  <span class='ivar'>@url</span> <span class='op'>=</span> <span class='const'>Url</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_url_params'>url_params</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@url</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Url was successfully created.</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>show</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:created</span><span class='comma'>,</span> <span class='label'>location:</span> <span class='ivar'>@url</span> <span class='rbrace'>}</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>new</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:unprocessable_entity</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="destroy-instance_method">
  
    - (<tt>Object</tt>) <strong>destroy</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>DELETE /urls/1 DELETE /urls/1.json</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


70
71
72
73
74
75
76</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 70</span>

<span class='kw'>def</span> <span class='id identifier rubyid_destroy'>destroy</span>
  <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span>
  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_urls_url'>urls_url</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_head'>head</span> <span class='symbol'>:no_content</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="edit-instance_method">
  
    - (<tt>Object</tt>) <strong>edit</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>GET /urls/1/edit</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


35
36</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 35</span>

<span class='kw'>def</span> <span class='id identifier rubyid_edit'>edit</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="find_urls-instance_method">
  
    - (<tt>Object</tt>) <strong>find_urls</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 176</span>

<span class='kw'>def</span> <span class='id identifier rubyid_find_urls'>find_urls</span>
  <span class='comment'># http://yandex.by/yandsearch?text=mtd+827+ast&amp;site=gepard.by
</span>  <span class='comment'># http://www.google.by/search?num=10&amp;q=mtd+827+ast+site:gepard.by
</span>  <span class='comment'># http://search.tut.by/?status=1&amp;ru=1&amp;encoding=1&amp;page=0&amp;how=rlv&amp;query=mtd+827+ast+site%3Agepard.by
</span>  <span class='comment'># http://nova.rambler.ru/search?utm_source=nhp&amp;query=mtd+827+ast+site%3Agepard.by
</span>  <span class='comment'># http://search.aol.com/aol/search?enabled_terms=&amp;s_it=comsearch51&amp;q=mtd+827+ast+site%3Agepard.by
</span>  <span class='comment'># http://www.nigma.ru/?s=mtd+827+ast+site%3Agepard.by
</span>  <span class='comment'># http://www.genon.ru/GetAnswer.aspx?QuestionText=mtd%20827%20ast%20site:gepard.by
</span>  <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_j'>j</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_z'>z</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_item_url'>item_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_url_column'>url_column</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>URL</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_site_param'>site_param</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SITE</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_css'>css</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>CSS</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_banned'>banned</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BANNED</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_current_engine'>current_engine</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_file_name'>file_name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/Users/Mikhail/RubymineProjects/distibutor/config/search/search_engines.xlsx</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_clients'>clients</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.57 Safari/537.36 OPR/16.0.1196.73</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
             <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_workbook'>workbook</span> <span class='op'>=</span> <span class='const'>RubyXL</span><span class='op'>::</span><span class='const'>Parser</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_file_name'>file_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='id identifier rubyid_workbook'>workbook</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_get_table'>get_table</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_url_column'>url_column</span><span class='comma'>,</span> <span class='id identifier rubyid_site_param'>site_param</span><span class='comma'>,</span> <span class='id identifier rubyid_css'>css</span><span class='comma'>,</span> <span class='id identifier rubyid_banned'>banned</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_groups'>groups</span> <span class='op'>=</span> <span class='const'>Group</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span>
  <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Started at </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_groups'>groups</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='op'>|</span>
    <span class='id identifier rubyid_group'>group</span><span class='period'>.</span><span class='id identifier rubyid_sites'>sites</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_site'>site</span><span class='op'>|</span>
      <span class='id identifier rubyid_group'>group</span><span class='period'>.</span><span class='id identifier rubyid_items'>items</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span>
        <span class='id identifier rubyid_z'>z</span> <span class='op'>=</span> <span class='id identifier rubyid_z'>z</span> <span class='op'>+</span> <span class='int'>1</span>
        <span class='id identifier rubyid_current_engine'>current_engine</span> <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>2</span><span class='op'>..</span><span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='rparen'>)</span><span class='op'>-</span><span class='int'>2</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_get_url'>get_url</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_site'>site</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_get_url'>get_url</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_site'>site</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='lparen'>(</span><span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_current_engine'>current_engine</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_banned'>banned</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>+</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
          <span class='comment'>#create search query
</span>          <span class='id identifier rubyid_search_query'>search_query</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_current_engine'>current_engine</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_url_column'>url_column</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='id identifier rubyid_group'>group</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>+</span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>+</span> <span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_current_engine'>current_engine</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_site_param'>site_param</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='id identifier rubyid_site'>site</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[\ \/]</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>+</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&amp;amp;</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&amp;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

          <span class='comment'>#find url for item
</span>          <span class='kw'>begin</span>
            <span class='id identifier rubyid_uri'>uri</span> <span class='op'>=</span> <span class='const'>URI</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_search_query'>search_query</span><span class='rparen'>)</span> <span class='comment'>#.encode(&quot;utf-8&quot;))
</span>            <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>---</span><span class='tstring_end'>&#39;</span></span>
            <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_current_engine'>current_engine</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_css'>css</span><span class='rbracket'>]</span>
            <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_uri'>uri</span>
            <span class='id identifier rubyid_page'>page</span> <span class='op'>=</span> <span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_uri'>uri</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>User-Agent</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.57 Safari/537.36 OPR/16.0.1196.73</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Accept</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Cache-Control</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>max-age=0</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
            <span class='id identifier rubyid_html'>html</span> <span class='op'>=</span> <span class='const'>Nokogiri</span><span class='op'>::</span><span class='const'>HTML</span> <span class='id identifier rubyid_page'>page</span>
            <span class='id identifier rubyid_item_url'>item_url</span> <span class='op'>=</span> <span class='id identifier rubyid_html'>html</span><span class='period'>.</span><span class='id identifier rubyid_at_css'>at_css</span><span class='lparen'>(</span><span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_values'>values</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_current_engine'>current_engine</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_css'>css</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:href</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>http:\/\/.*</span><span class='regexp_end'>/</span></span><span class='rbracket'>]</span>
            <span class='id identifier rubyid_sleep_time'>sleep_time</span> <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>200</span><span class='op'>..</span><span class='int'>700</span><span class='rparen'>)</span><span class='op'>/</span><span class='int'>100</span>

            <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span>
            <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='rparen'>)</span>
          <span class='kw'>rescue</span> <span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
            <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_e'>e</span>
            <span class='kw'>if</span> <span class='id identifier rubyid_item_url'>item_url</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
              <span class='comment'>#workbook.worksheets[0][current_engine][3].change_contents(&quot;+&quot;)
</span>              <span class='comment'>#workbook.write(file_name)
</span>              <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_workbook'>workbook</span><span class='period'>.</span><span class='id identifier rubyid_worksheets'>worksheets</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_current_engine'>current_engine</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Banned at </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
            <span class='kw'>end</span>

            <span class='id identifier rubyid_j'>j</span> <span class='op'>=</span> <span class='id identifier rubyid_j'>j</span> <span class='op'>+</span> <span class='int'>1</span>
          <span class='kw'>end</span>

          <span class='comment'>#create url, save url and item
</span>          <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_item_url'>item_url</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_item_url'>item_url</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
            <span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='const'>Url</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
            <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='id identifier rubyid_item_url'>item_url</span>
            <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_site'>site</span> <span class='op'>=</span> <span class='id identifier rubyid_site'>site</span>
            <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_urls'>urls</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_url'>url</span>
            <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
            <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>

            <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
            <span class='id identifier rubyid_item_url'>item_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
          <span class='kw'>end</span>
          <span class='comment'>#redirect_to urls_path
</span>
        <span class='kw'>end</span>

      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_i'>i</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_j'>j</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_z'>z</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Finished at </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_urls_path'>urls_path</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="index-instance_method">
  
    - (<tt>Object</tt>) <strong>index</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>GET /urls GET /urls.json</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


14
15
16
17
18
19
20
21
22</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 14</span>

<span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
  <span class='id identifier rubyid_group'>group</span> <span class='op'>=</span> <span class='const'>Group</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>KARCHER</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='id identifier rubyid_items'>items</span> <span class='op'>=</span> <span class='id identifier rubyid_group'>group</span><span class='period'>.</span><span class='id identifier rubyid_items'>items</span>
  <span class='ivar'>@urls</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_items'>items</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span>
    <span class='ivar'>@urls</span> <span class='op'>+=</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_urls'>urls</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="new-instance_method">
  
    - (<tt>Object</tt>) <strong>new</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>GET /urls/new</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


30
31
32</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 30</span>

<span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@url</span> <span class='op'>=</span> <span class='const'>Url</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="show-instance_method">
  
    - (<tt>Object</tt>) <strong>show</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>GET /urls/1 GET /urls/1.json</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


26
27</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 26</span>

<span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update-instance_method">
  
    - (<tt>Object</tt>) <strong>update</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>PATCH/PUT /urls/1 PATCH/PUT /urls/1.json</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58
59
60
61
62
63
64
65
66</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 56</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>
  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='id identifier rubyid_url_params'>url_params</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@url</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Url was successfully updated.</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_head'>head</span> <span class='symbol'>:no_content</span> <span class='rbrace'>}</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>edit</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:unprocessable_entity</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_prices-instance_method">
  
    - (<tt>Object</tt>) <strong>update_prices</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 90</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_prices'>update_prices</span>
  <span class='id identifier rubyid_current_site'>current_site</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:site</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='const'>Site</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:site</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_current_site'>current_site</span><span class='period'>.</span><span class='id identifier rubyid_update_prices'>update_prices</span>

  <span class='comment'>#if current_site.nil?
</span>  <span class='comment'>#  redirect_to sites_path
</span>  <span class='comment'>#end
</span>  <span class='comment'>#rate = current_user.settings.rate
</span>  <span class='comment'>#allowed_error = current_user.settings.allowed_error
</span>  <span class='comment'>#urls = params[:site].nil? ? Url.all : current_site.urls
</span>  <span class='comment'>#p urls.count
</span>  <span class='comment'>#urls.each do |url|
</span>  <span class='comment'>#  css = url.site.css
</span>  <span class='comment'>#  regexp = url.site.regexp
</span>  <span class='comment'>#  url.delay(run_at: 10.seconds.from_now).update_price(css, regexp, rate)
</span>  <span class='comment'>#  url.delay(run_at: 10.seconds.from_now).check_for_violation(url.item.get_standard_price ,allowed_error)
</span>  <span class='comment'>#end
</span>  <span class='comment'>#current_user.settings.last_updated = Time.now
</span>  <span class='comment'>#current_user.settings.save
</span>  <span class='comment'>#current_site.delay(run_at: 10.seconds.from_now).check_for_violation
</span>
  <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:notice</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Цены обновляются. Обычно это занимает 1-2 минуты для каждого сайта.</span><span class='tstring_end'>&quot;</span></span>


  <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_site_path'>site_path</span><span class='lparen'>(</span><span class='id identifier rubyid_current_site'>current_site</span><span class='rparen'>)</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_single_price-instance_method">
  
    - (<tt>Object</tt>) <strong>update_single_price</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


78
79
80
81
82
83
84
85
86
87
88</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 78</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_single_price'>update_single_price</span>
  <span class='id identifier rubyid_rate'>rate</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_rate'>rate</span>
  <span class='id identifier rubyid_css'>css</span> <span class='op'>=</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_site'>site</span><span class='period'>.</span><span class='id identifier rubyid_css'>css</span>
  <span class='id identifier rubyid_regexp'>regexp</span> <span class='op'>=</span> <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_site'>site</span><span class='period'>.</span><span class='id identifier rubyid_regexp'>regexp</span>
  <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_update_price'>update_price</span><span class='lparen'>(</span><span class='id identifier rubyid_css'>css</span><span class='comma'>,</span> <span class='id identifier rubyid_regexp'>regexp</span><span class='comma'>,</span> <span class='id identifier rubyid_rate'>rate</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_standard_site'>standard_site</span> <span class='op'>=</span> <span class='const'>Site</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>standard:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='id identifier rubyid_standard_price'>standard_price</span> <span class='op'>=</span> <span class='id identifier rubyid_get_price'>get_price</span><span class='lparen'>(</span><span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_standard_site'>standard_site</span><span class='rparen'>)</span>
  <span class='ivar'>@url</span><span class='period'>.</span><span class='id identifier rubyid_check_for_violation'>check_for_violation</span><span class='lparen'>(</span><span class='id identifier rubyid_standard_price'>standard_price</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_allowed_error'>allowed_error</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_logs_path'>logs_path</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_violators-instance_method">
  
    - (<tt>Object</tt>) <strong>update_violators</strong>(redirect_to_root = true, site_id = nil) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/urls_controller.rb', line 118</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_violators'>update_violators</span> <span class='lparen'>(</span><span class='id identifier rubyid_redirect_to_root'>redirect_to_root</span><span class='op'>=</span><span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_site_id'>site_id</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_allowed_error'>allowed_error</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_allowed_error'>allowed_error</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_site_id'>site_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_groups'>groups</span> <span class='op'>=</span> <span class='const'>Group</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span>
    <span class='id identifier rubyid_all_sites'>all_sites</span> <span class='op'>=</span> <span class='const'>Site</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_current_site'>current_site</span> <span class='op'>=</span> <span class='const'>Site</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_site_id'>site_id</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_groups'>groups</span> <span class='op'>=</span> <span class='id identifier rubyid_current_site'>current_site</span><span class='period'>.</span><span class='id identifier rubyid_groups'>groups</span>
    <span class='id identifier rubyid_all_sites'>all_sites</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_current_site'>current_site</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_groups'>groups</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span>
  <span class='id identifier rubyid_groups'>groups</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_group'>group</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_site_id'>site_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_items'>items</span> <span class='op'>=</span> <span class='id identifier rubyid_group'>group</span><span class='period'>.</span><span class='id identifier rubyid_items'>items</span>
      <span class='id identifier rubyid_standard_site'>standard_site</span> <span class='op'>=</span> <span class='id identifier rubyid_group'>group</span><span class='period'>.</span><span class='id identifier rubyid_sites'>sites</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:standard</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_items'>items</span> <span class='op'>=</span> <span class='id identifier rubyid_current_site'>current_site</span><span class='period'>.</span><span class='id identifier rubyid_items'>items</span> <span class='op'>&amp;</span> <span class='id identifier rubyid_group'>group</span><span class='period'>.</span><span class='id identifier rubyid_items'>items</span>
      <span class='id identifier rubyid_standard_site'>standard_site</span> <span class='op'>=</span> <span class='id identifier rubyid_current_site'>current_site</span><span class='period'>.</span><span class='id identifier rubyid_groups'>groups</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_sites'>sites</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:standard</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_standard_site'>standard_site</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_items'>items</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span>
    <span class='id identifier rubyid_items'>items</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span>
      <span class='id identifier rubyid_standard_price'>standard_price</span> <span class='op'>=</span> <span class='id identifier rubyid_get_price'>get_price</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='comma'>,</span> <span class='id identifier rubyid_standard_site'>standard_site</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_standard_price'>standard_price</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_standard_price'>standard_price</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='id identifier rubyid_urls'>urls</span> <span class='op'>=</span> <span class='id identifier rubyid_site_id'>site_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='id identifier rubyid_current_site'>current_site</span><span class='period'>.</span><span class='id identifier rubyid_urls'>urls</span> <span class='op'>&amp;</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_urls'>urls</span>
        <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_url'>url</span><span class='op'>|</span>
          <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_price'>price</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
            <span class='comment'>#p &quot;----&quot;, item.name, url.url, &quot;%.1f&quot; % url.price, &quot;%.1f&quot; % standard_price
</span>            <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_delay'>delay</span><span class='lparen'>(</span><span class='label'>run_at:</span> <span class='int'>3</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span><span class='period'>.</span><span class='id identifier rubyid_from_now'>from_now</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_check_for_violation'>check_for_violation</span><span class='lparen'>(</span><span class='id identifier rubyid_standard_price'>standard_price</span><span class='comma'>,</span> <span class='id identifier rubyid_allowed_error'>allowed_error</span><span class='rparen'>)</span>
            <span class='comment'>#p url.violator?
</span>          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_url'>url</span><span class='op'>|</span>
          <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_violator'>violator</span> <span class='op'>=</span> <span class='kw'>false</span>
          <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span> <span class='kw'>if</span> <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_changed?'>changed?</span>
        <span class='kw'>end</span>

      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_all_sites'>all_sites</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_site'>site</span><span class='op'>|</span>
    <span class='id identifier rubyid_site'>site</span><span class='period'>.</span><span class='id identifier rubyid_delay'>delay</span><span class='lparen'>(</span><span class='label'>run_at:</span> <span class='int'>3</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span><span class='period'>.</span><span class='id identifier rubyid_from_now'>from_now</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_check_for_violation'>check_for_violation</span>
    <span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_site'>site</span><span class='period'>.</span><span class='id identifier rubyid_violator?'>violator?</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:notice</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Список нарушителей обновляется</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_redirect_to_root'>redirect_to_root</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_root_path'>root_path</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Nov 15 17:37:54 2013 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.2 (ruby-2.0.0).
</div>

  </body>
</html>